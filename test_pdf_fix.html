<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PDF Generation Fix</title>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <h1>PDF Generation Test</h1>
    
    <!-- Test Chart Elements -->
    <div id="taxonomy-pie-chart" style="width: 400px; height: 300px; background: #f0f0f0; border: 1px solid #ccc; margin: 20px 0; padding: 20px;">
        <h3>Taxonomic Composition Chart</h3>
        <div style="width: 100px; height: 100px; background: #22D3EE; border-radius: 50%; margin: 20px auto;"></div>
        <p>Sample pie chart placeholder</p>
    </div>
    
    <div id="confidence-bar-chart" style="width: 400px; height: 250px; background: #f8f8f8; border: 1px solid #ddd; margin: 20px 0; padding: 20px;">
        <h3>Confidence Distribution</h3>
        <div style="display: flex; align-items: end; gap: 10px; height: 150px; margin-top: 20px;">
            <div style="width: 40px; height: 120px; background: #06b6d4;"></div>
            <div style="width: 40px; height: 80px; background: #06b6d4;"></div>
            <div style="width: 40px; height: 40px; background: #06b6d4;"></div>
        </div>
    </div>
    
    <div id="novelty-bar-chart" style="width: 400px; height: 250px; background: #f8f8f8; border: 1px solid #ddd; margin: 20px 0; padding: 20px;">
        <h3>Novelty Score Distribution</h3>
        <div style="display: flex; align-items: end; gap: 10px; height: 150px; margin-top: 20px;">
            <div style="width: 30px; height: 100px; background: #8b5cf6;"></div>
            <div style="width: 30px; height: 80px; background: #8b5cf6;"></div>
            <div style="width: 30px; height: 60px; background: #8b5cf6;"></div>
            <div style="width: 30px; height: 30px; background: #8b5cf6;"></div>
            <div style="width: 30px; height: 15px; background: #8b5cf6;"></div>
        </div>
    </div>
    
    <button onclick="testPDFGeneration()">Test PDF Generation</button>
    
    <script>
        // Simplified PDF Generator for testing
        class TestPDFGenerator {
            constructor() {
                this.pdf = new jsPDF('p', 'mm', 'a4');
                this.pageWidth = this.pdf.internal.pageSize.getWidth();
                this.pageHeight = this.pdf.internal.pageSize.getHeight();
                this.margin = 20;
                this.currentY = this.margin;
            }
            
            async addChartFromElement(elementId, title) {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.warn(`Element ${elementId} not found`);
                    return;
                }
                
                try {
                    console.log(`Capturing ${elementId}...`);
                    
                    const canvas = await html2canvas(element, {
                        backgroundColor: '#ffffff',
                        scale: 1.2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    if (canvas.width === 0 || canvas.height === 0) {
                        throw new Error('Canvas has zero dimensions');
                    }
                    
                    const imgData = canvas.toDataURL('image/png', 0.9);
                    
                    if (!imgData || imgData === 'data:,') {
                        throw new Error('Invalid image data');
                    }
                    
                    // Add title
                    this.pdf.setFontSize(14);
                    this.pdf.text(title, this.margin, this.currentY);
                    this.currentY += 10;
                    
                    // Add image
                    const imgWidth = this.pageWidth - 2 * this.margin;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    this.pdf.addImage(imgData, 'PNG', this.margin, this.currentY, imgWidth, Math.min(imgHeight, 80));
                    this.currentY += Math.min(imgHeight, 80) + 20;
                    
                    console.log(`‚úÖ Successfully captured ${elementId}`);
                } catch (error) {
                    console.error(`‚ùå Error capturing ${elementId}:`, error);
                    this.pdf.text(`Chart capture failed: ${title}`, this.margin, this.currentY);
                    this.currentY += 10;
                }
            }
            
            async generateTestReport() {
                // Title
                this.pdf.setFontSize(20);
                this.pdf.text('TaxaFormer Test Report', this.margin, this.currentY);
                this.currentY += 20;
                
                // Charts
                await this.addChartFromElement('taxonomy-pie-chart', 'Taxonomic Composition');
                await this.addChartFromElement('confidence-bar-chart', 'Confidence Distribution');
                await this.addChartFromElement('novelty-bar-chart', 'Novelty Score Distribution');
                
                // Download
                this.pdf.save('test-report.pdf');
                console.log('‚úÖ Test PDF generated successfully');
            }
        }
        
        async function testPDFGeneration() {
            try {
                console.log('üîÑ Starting PDF generation test...');
                const generator = new TestPDFGenerator();
                await generator.generateTestReport();
            } catch (error) {
                console.error('‚ùå PDF generation failed:', error);
                alert('PDF generation failed: ' + error.message);
            }
        }
    </script>
</body>
</html>